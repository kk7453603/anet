# Маскировка трафика (Stealth)

ANet предоставляет механизмы для противодействия системам глубокого анализа пакетов (Deep Packet Inspection, DPI). Настройки маскировки управляются секцией `[stealth]` в конфигурации клиента и сервера.

## Обзор методов DPI-анализа

Системы DPI используют несколько подходов для обнаружения VPN-трафика:

- **Анализ размеров пакетов** — характерные размеры позволяют идентифицировать протокол (например, рукопожатие WireGuard всегда составляет 148 байт)
- **Анализ временных интервалов (Timing Analysis)** — если пакет поступает на сервер и немедленно отправляется далее, это указывает на прокси или VPN
- **Поиск сигнатур** — фиксированные заголовки и магические числа в пакетах

ASTP изначально лишён фиксированных сигнатур: все данные зашифрованы и неотличимы от случайных байт. Параметры padding и jitter дополнительно затрудняют статистический анализ трафика.

## Выравнивание размера пакетов (Padding)

### Описание

Padding дополняет размер каждого пакета до ближайшего значения, кратного заданному шагу. Дополнительные байты заполняются случайными данными (для рукопожатия) или нулями (для пакетов данных).

### Параметр `padding_step`

| Значение | Описание |
| --- | --- |
| `0` | Отключено. Пакеты имеют естественный размер. Отсутствие паттернов фиксированных размеров может быть полезно против систем, обученных распознавать искусственное выравнивание |
| `64` | Рекомендуемое значение. Оптимальный баланс между маскировкой и накладными расходами |
| `128` | Повышенная маскировка. Увеличенный расход трафика за счёт более крупного шага выравнивания |

### Пример

При `padding_step = 64` пакет размером 100 байт будет дополнен до 128 байт, пакет размером 130 байт — до 192 байт.

### Конфигурация

```toml
[stealth]
padding_step = 64
```

## Имитация задержек сети (Jitter)

### Описание

Jitter добавляет случайную задержку перед отправкой каждого пакета. Величина задержки выбирается случайно из диапазона `[min_jitter_ns, max_jitter_ns]`. Это нарушает временную корреляцию между входящим и исходящим трафиком, а также может приводить к изменению порядка пакетов, что имитирует поведение загруженной сети.

### Параметры

| Параметр | Описание |
| --- | --- |
| `min_jitter_ns` | Минимальная задержка в наносекундах |
| `max_jitter_ns` | Максимальная задержка в наносекундах |

> 1 миллисекунда = 1 000 000 наносекунд

Для отключения jitter установите оба параметра в `0`.

### Пресеты

#### Минимальный

Практически не влияет на задержку соединения. Сбивает точные тайминги.

```toml
[stealth]
min_jitter_ns = 100000     # 0.1 мс
max_jitter_ns = 500000     # 0.5 мс
```

#### Сбалансированный (рекомендуемый)

Эффективная маскировка временных паттернов. Увеличение задержки составляет около 3 мс.

```toml
[stealth]
min_jitter_ns = 1000000    # 1 мс
max_jitter_ns = 5000000    # 5 мс
```

#### Параноидальный

Максимальная маскировка. Увеличение задержки до 15 мс. Может негативно сказаться на интерактивных приложениях (игры, видеозвонки).

```toml
[stealth]
min_jitter_ns = 5000000    # 5 мс
max_jitter_ns = 20000000   # 20 мс
```

## Согласованность настроек

Параметры секции `[stealth]` настраиваются **независимо** на клиенте и сервере. Каждая сторона применяет padding и jitter к своим исходящим пакетам.

Для достижения наилучшего эффекта маскировки рекомендуется использовать одинаковые или близкие значения на обеих сторонах.

## Влияние на производительность

| Параметр | Влияние на задержку | Влияние на трафик |
| --- | --- | --- |
| `padding_step = 0` | Нет | Нет |
| `padding_step = 64` | Нет | Увеличение до ~30% (зависит от размера пакетов) |
| `padding_step = 128` | Нет | Увеличение до ~50% |
| Jitter (минимальный) | +0.1–0.5 мс | Нет |
| Jitter (сбалансированный) | +1–5 мс | Нет |
| Jitter (параноидальный) | +5–20 мс | Нет |

> Padding увеличивает только объём передаваемых данных, но не влияет на задержку. Jitter увеличивает задержку, но не влияет на объём трафика.

## Полный пример конфигурации

```toml
[stealth]
padding_step = 64
min_jitter_ns = 1000000
max_jitter_ns = 5000000
```

Эта конфигурация обеспечивает оптимальный баланс между степенью маскировки и влиянием на производительность.
