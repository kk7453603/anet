# Сервер авторизации (anet-auth)

`anet-auth` — HTTP-микросервис для управления пользователями VPN. Позволяет добавлять и отключать клиентов без перезапуска VPN-сервера.

## Назначение

При использовании только параметра `allowed_clients` в конфигурации сервера каждое добавление или удаление клиента требует редактирования конфигурационного файла и перезапуска `anet-server`.

`anet-auth` решает эту проблему: VPN-сервер обращается к нему по HTTP для проверки клиентских отпечатков в реальном времени.

## Логика авторизации

При подключении клиента VPN-сервер выполняет проверку в следующем порядке:

1. Поиск отпечатка в списке `allowed_clients` — если найден, клиент допускается
2. Если не найден и серверы авторизации (`auth_servers`) не настроены — клиент отклоняется
3. Если настроены `auth_servers` — последовательный запрос к каждому серверу; клиент допускается, если хотя бы один сервер вернёт положительный ответ

## Требования

- PostgreSQL (версия 12 или выше)
- Сетевая доступность между `anet-server` и `anet-auth`

## Развёртывание

### Шаг 1. Запуск PostgreSQL

Готовый файл Docker Compose находится в `contrib/docker/docker-compose.infra.yaml`:

```bash
cd contrib/docker
cp docker-compose.infra.yaml docker-compose.yaml
# При необходимости отредактируйте логин, пароль и порт
docker-compose up -d
```

Либо используйте команду `make infra` из корня проекта.

### Шаг 2. Настройка переменных окружения

Скопируйте шаблон файла окружения:

```bash
cp contrib/config/.env.example.auth .env
```

Отредактируйте `.env`:

```ini
# Строка подключения к PostgreSQL
DATABASE_URL=postgres://user:password@localhost:5432/anet_auth_db

# Секретный ключ для аутентификации запросов от VPN-сервера
AUTH_BACKEND_KEY=your_secret_key_here

# Адрес и порт для прослушивания
BIND_TO=127.0.0.1:3000
```

> Рекомендуется привязывать `anet-auth` к localhost (`127.0.0.1`), если он работает на том же хосте, что и VPN-сервер. Это исключает доступ к API из внешней сети.

### Шаг 3. Запуск сервиса

```bash
./anet-auth
```

При первом запуске автоматически выполняются миграции базы данных.

Для запуска через systemd используйте unit-файл из `contrib/systemd/anet-auth.service`.

## Управление пользователями

### Добавление пользователя

```bash
./anet-auth -a username
```

Команда создаёт нового пользователя в базе данных и выводит сгенерированные ключи:

- Приватный ключ клиента — передаётся пользователю
- Отпечаток — регистрируется автоматически в базе данных

### Управление через базу данных

Структура таблицы `users`:

| Поле | Тип | Описание |
| --- | --- | --- |
| `id` | UUID | Уникальный идентификатор (генерируется автоматически) |
| `fingerprint` | Text (UNIQUE) | Отпечаток клиента (Base64) |
| `uid` | Text | Имя пользователя |
| `is_active` | Boolean | Активность учётной записи (по умолчанию `true`) |
| `created_at` | DateTime | Дата создания |
| `updated_at` | DateTime | Дата последнего изменения |

Для деактивации пользователя без удаления установите `is_active = false`:

```sql
UPDATE users SET is_active = false WHERE uid = 'username';
```

## Подключение к VPN-серверу

В конфигурации `server.toml`:

```toml
[authentication]
allowed_clients = []                                    # локальный список (проверяется первым)
auth_servers = ["http://127.0.0.1:3000/api/v1"]        # адрес anet-auth
auth_server_token = "your_secret_key_here"              # должен совпадать с AUTH_BACKEND_KEY
```

Параметр `auth_server_token` передаётся в заголовке `X-Auth-Key` при каждом запросе к серверу авторизации.

После изменения конфигурации необходим перезапуск `anet-server`.

## REST API

### Проверка доступа

```
POST /api/v1/check_access
```

Заголовки:

```
X-Auth-Key: your_secret_key_here
Content-Type: application/json
```

Тело запроса:

```json
{
    "fingerprint": "f+f9KfEh/kuAZUzLMT4z7A=="
}
```

Ответ:

```json
{
    "allowed": true,
    "message": "Access granted"
}
```

Возможные значения `message`:

| Сообщение | Описание |
| --- | --- |
| `Access granted` | Пользователь активен, доступ разрешён |
| `Account is banned or inactive` | Учётная запись деактивирована (`is_active = false`) |
| `User not found` | Отпечаток не найден в базе данных |

### Документация API

Интерактивная документация Swagger UI доступна по адресу:

```
http://127.0.0.1:3000/swagger
```

Спецификация OpenAPI:

```
http://127.0.0.1:3000/spec
```

## Масштабирование

Можно развернуть несколько экземпляров `anet-auth` на разных хостах с общей или раздельными базами данных. VPN-сервер поддерживает список серверов авторизации и опрашивает их последовательно:

```toml
[authentication]
auth_servers = [
    "http://auth1.internal:3000/api/v1",
    "http://auth2.internal:3000/api/v1"
]
```

Клиент будет допущен, если хотя бы один сервер из списка подтвердит доступ.
