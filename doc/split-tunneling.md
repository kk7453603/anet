# Раздельное туннелирование (Split Tunneling)

Раздельное туннелирование позволяет направлять через VPN только определённый трафик, а остальной передавать напрямую через физическое соединение (или наоборот).

## Принцип работы

ANet поддерживает два режима раздельного туннелирования, управляемых параметрами `route_for` и `exclude_route_for` в секции `[main]` конфигурации клиента.

Выбор режима определяется автоматически:

- Если `route_for` **не пуст** — активируется режим INCLUDE (белый список)
- Если `route_for` **пуст** — активируется режим EXCLUDE (чёрный список)

## Поддерживаемые форматы адресов

В обоих списках допустимы следующие форматы:

| Формат | Пример | Описание |
| --- | --- | --- |
| Доменное имя | `"youtube.com"` | Резолвится в IP-адреса при запуске клиента |
| Одиночный IP | `"203.0.113.10"` | Конкретный IP-адрес |
| CIDR-подсеть | `"192.168.0.0/16"` | Диапазон IP-адресов |

> Доменные имена резолвятся **однократно при запуске** клиента с использованием DNS-серверов из параметра `dns_server_list`. Если IP-адрес домена изменится после запуска, маршрутизация не обновится автоматически. Для применения изменений необходим перезапуск клиента.

## Режим EXCLUDE (чёрный список)

Режим по умолчанию. Активируется, когда `route_for` пуст (или не указан).

**Принцип:** весь трафик направляется через VPN-туннель. Исключения — адреса из списка `exclude_route_for`, которые передаются напрямую через физический шлюз.

### Техническая реализация

1. Сохраняется текущий маршрут по умолчанию (шлюз и интерфейс)
2. Для каждого адреса из `exclude_route_for` и IP-адреса VPN-сервера добавляется маршрут через физический шлюз
3. Устанавливаются два маршрута `/1` через TUN-интерфейс: `0.0.0.0/1` и `128.0.0.0/1`, которые перекрывают маршрут по умолчанию (`0.0.0.0/0`), не удаляя его

### Типичные сценарии

#### Доступ к локальной сети

```toml
[main]
exclude_route_for = ["192.168.0.0/16", "10.0.0.0/8"]
```

Сохраняет доступ к устройствам в локальной сети (принтеры, NAS, умный дом) при активном VPN.

#### Банковские и корпоративные сервисы

```toml
[main]
exclude_route_for = [
    "192.168.0.0/16",
    "online.sberbank.ru",
    "jira.company.com"
]
```

Исключает из VPN ресурсы, которые блокируют доступ с иностранных IP-адресов.

#### Комбинированный пример

```toml
[main]
exclude_route_for = [
    "192.168.1.0/24",       # домашняя сеть
    "10.0.50.0/24",         # корпоративная VPN
    "online.sberbank.ru",   # банк
    "gosuslugi.ru"          # госуслуги
]
```

## Режим INCLUDE (белый список)

Активируется, когда `route_for` содержит хотя бы один элемент. Параметр `exclude_route_for` в этом режиме **игнорируется**.

**Принцип:** весь трафик передаётся напрямую. Через VPN-туннель направляется **только** трафик к адресам из списка `route_for`.

### Техническая реализация

Для каждого адреса из `route_for` добавляется маршрут через TUN-интерфейс. Маршрут по умолчанию не изменяется.

### Типичные сценарии

#### Доступ к заблокированным ресурсам

```toml
[main]
route_for = [
    "youtube.com",
    "twitter.com",
    "instagram.com",
    "discord.com"
]
```

Через VPN проходит только трафик к указанным ресурсам. Остальной интернет-трафик идёт напрямую.

#### Доступ к определённой подсети

```toml
[main]
route_for = ["10.100.0.0/16"]
```

Через VPN доступна только указанная подсеть (например, удалённый офис).

## Настройка DNS-резолвера

Параметр `dns_server_list` определяет DNS-серверы, используемые для преобразования доменных имён из `route_for` и `exclude_route_for` в IP-адреса при запуске клиента.

```toml
[main]
dns_server_list = ["1.1.1.1", "8.8.8.8"]
```

Рекомендуется использовать надёжные публичные DNS-серверы для получения актуальных записей.

## Ручное управление маршрутизацией

Параметр `manual_routing = true` полностью отключает автоматическую настройку маршрутов. В этом режиме клиент создаёт TUN-интерфейс и устанавливает VPN-соединение, но не вносит изменений в таблицу маршрутизации. Настройка маршрутов выполняется администратором вручную.

```toml
[main]
manual_routing = true
```

> Параметр `manual_routing` не действует в GUI-клиенте.

## Рекомендации

- При отсутствии специфических требований используйте **режим EXCLUDE** — он обеспечивает полное шифрование трафика с возможностью исключения отдельных ресурсов
- Добавляйте в `exclude_route_for` подсеть локальной сети для сохранения доступа к локальным устройствам
- Режим INCLUDE предпочтителен, когда VPN используется для доступа к ограниченному набору ресурсов и нежелательно направлять весь трафик через удалённый сервер
