# Решение типичных проблем

## Клиент не подключается (таймаут рукопожатия)

### Симптомы

В логе клиента отображаются сообщения о повторных попытках подключения:

```text
[AUTH] Attempt 1/10 failed, retrying in 5s...
[AUTH] Attempt 2/10 failed, retrying in 10s...
```

### Возможные причины и решения

**1. UDP-порт сервера закрыт**

Убедитесь, что порт доступен:

```bash
# На клиенте
nc -zuv vpn.example.com 8443
```

На сервере проверьте правила firewall:

```bash
iptables -L INPUT -n | grep 8443
```

Если правило отсутствует:

```bash
iptables -I INPUT -p udp --dport 8443 -j ACCEPT
```

**2. Неверный публичный ключ сервера**

Клиент шифрует пакеты рукопожатия ключом, производным от публичного ключа сервера. При несовпадении ключей сервер не сможет расшифровать пакеты и проигнорирует их.

Убедитесь, что значение `server_pub_key` в `client.toml` соответствует публичному ключу, полученному при генерации ключей сервера (`anet-keygen server`).

**3. Отпечаток клиента отсутствует в списке разрешённых**

Сервер отклоняет подключения от клиентов, не зарегистрированных в `allowed_clients` или `anet-auth`. При уровне логирования `debug` в логе сервера будет:

```text
[AUTH] Client fingerprint not found in allowed list
```

Добавьте отпечаток клиента в `allowed_clients` в `server.toml` и перезапустите сервер, или зарегистрируйте через `anet-auth`.

**4. Несовместимые версии клиента и сервера**

Клиент и сервер должны использовать одну версию протокола (второе число в номере версии: `v0.X.*`).

## Подключение установлено, но нет интернета

### Симптомы

Рукопожатие завершено, TUN-интерфейс создан, IP-адрес получен, но доступ в интернет отсутствует.

### Возможные причины и решения

**1. Не настроена маршрутизация на сервере**

Проверьте правила iptables:

```bash
iptables -L FORWARD -n
iptables -t nat -L POSTROUTING -n
```

Убедитесь в наличии правил FORWARD между внешним интерфейсом и TUN-интерфейсом, а также правила MASQUERADE. См. раздел [Настройка маршрутизации](server-setup.md#шаг-6-настройка-маршрутизации-трафика).

**2. IP forwarding отключён**

```bash
cat /proc/sys/net/ipv4/ip_forward
```

Если значение `0`, включите:

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
```

Для постоянного включения добавьте в `/etc/sysctl.conf`:

```ini
net.ipv4.ip_forward = 1
```

**3. Неверное имя внешнего интерфейса**

Убедитесь, что значение `external_if` в `server.toml` соответствует фактическому имени интерфейса:

```bash
ip route show default
```

**4. Проблема с MTU**

Если страницы загружаются частично или не загружаются вообще, возможно, MTU слишком велик. Уменьшите значение `mtu` в секции `[network]` сервера (рекомендуемый диапазон: 1200–1400):

```toml
[network]
mtu = 1300
```

## Низкая скорость соединения

### Диагностика

Включите статистику QUIC-соединения:

```toml
[stats]
enabled = true
interval_minutes = 1
```

В логе будут отображаться метрики соединения, включая RTT, потери пакетов и размеры окон.

### Возможные причины и решения

**1. Некорректные параметры канала**

Если `expected_rtt_ms` значительно отличается от реального RTT, или `bandwidth_down/up_mbps` не соответствуют фактической пропускной способности, автоматический расчёт буферов будет неоптимальным.

Измерьте реальный RTT (`ping`) и укажите корректные значения в `[quic_transport]`. См. [Настройка QUIC-транспорта](quic-tuning.md).

**2. Алгоритм контроля перегрузки**

При высоких потерях пакетов CUBIC может значительно снижать скорость. Переключитесь на BBR:

```toml
[quic_transport]
algorithm = "bbr"
```

**3. Влияние параметров stealth**

Высокие значения jitter добавляют задержку к каждому пакету. Для диагностики временно отключите:

```toml
[stealth]
min_jitter_ns = 0
max_jitter_ns = 0
```

## DNS не работает через VPN

### Симптомы

Сайты не открываются по доменным именам, но доступны по IP-адресам.

### Возможные причины и решения

**1. DNS-сервер недоступен через VPN**

Проверьте доступность DNS-сервера:

```bash
nslookup google.com 1.1.1.1
```

**2. Конфликт с systemd-resolved (Linux)**

Если `/etc/resolv.conf` является символической ссылкой (управляется `systemd-resolved`), ANet предупредит об этом в логе. В этом случае DNS-настройки могут не применяться корректно.

Варианты решения:

- Отключить `systemd-resolved` и управлять `/etc/resolv.conf` напрямую
- Настроить DNS вручную после подключения

**3. DNS-серверы в split tunneling**

При использовании режима INCLUDE убедитесь, что DNS-серверы (1.1.1.1, 8.8.8.8 или используемые вами) включены в список `route_for` или доступны без VPN.

## Проблемы с маршрутизацией при split tunneling

### Симптомы

Некоторые ресурсы недоступны через VPN или, наоборот, не исключаются из него.

### Возможные причины и решения

**1. Неверный формат адреса**

Проверьте формат записей в `route_for` / `exclude_route_for`. Допустимые форматы:

```toml
route_for = [
    "youtube.com",         # доменное имя
    "203.0.113.10",        # одиночный IP
    "192.168.0.0/16"       # CIDR-подсеть
]
```

**2. Домен резолвится в другой IP**

Доменные имена резолвятся при запуске клиента. Если CDN возвращает разные IP-адреса, маршрутизация может работать некорректно. Добавьте IP-подсети сервиса вместо доменных имён.

**3. Конфликт режимов**

Если заполнен `route_for`, параметр `exclude_route_for` игнорируется. Используйте только один из двух списков.

Подробнее см. [Раздельное туннелирование](split-tunneling.md).

## Ошибка Permission denied / недостаточно прав

### Симптомы

```text
Error: Permission denied (os error 13)
```

или

```text
Failed to create TUN interface
```

### Решение

Клиент и сервер требуют прав суперпользователя для создания TUN-интерфейса:

```bash
# Linux / macOS
sudo ./anet-client -c client.toml
sudo ./anet-server -c server.toml
```

На Windows запустите от имени администратора.

## Маршруты не восстанавливаются после аварийного завершения

### Симптомы

После аварийного завершения клиента интернет-соединение не работает (маршруты через TUN остались, но интерфейс удалён).

### Решение

Вручную удалите маршруты, добавленные ANet:

```bash
# Linux
ip route del 0.0.0.0/1
ip route del 128.0.0.0/1

# macOS
route delete -net 0.0.0.0/1
route delete -net 128.0.0.0/1
```

Либо перезапустите клиент — при штатном завершении маршруты будут восстановлены автоматически.

## Диагностика

### Включение подробного логирования

```bash
sudo RUST_LOG=debug ./anet-client -c client.toml
```

Уровни логирования (от минимального к максимальному): `error`, `warn`, `info`, `debug`, `trace`.

Контекстные префиксы в логе:

| Префикс | Компонент |
| --- | --- |
| `[AUTH]` | Рукопожатие и авторизация |
| `[VPN]` | QUIC-туннель и передача данных |
| `[Core]` | Инициализация и управление клиентом |
| `[Registry]` | Реестр клиентов (сервер) |
| `[STATS]` | Статистика соединения |
